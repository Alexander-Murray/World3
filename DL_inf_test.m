clear all;
close all;
clc;

fcfpc = [0.0886879,0.0886879,0.0886879,0.0886879,0.08868839,...
0.08868377,0.08866563,0.08862472,0.08855218,0.08844018,...
0.08828231,0.08807371,0.08781108,0.08749259,0.08711785,...
0.08668769,0.08620398,0.08566941,0.08508734,0.08446168,...
0.08379671,0.08309699,0.08236725,0.08161233,0.08083704,...
0.0800462,0.07924448,0.07843645,0.07762651,0.07681885,...
0.07601747,0.07522618,0.07444853,0.07368787,0.07294729,...
0.07222969,0.07153771,0.07087379,0.07024017,0.06963885,...
0.06907169,0.06854035,0.06804632,0.06759095,0.06717546,...
0.06680092,0.06646831,0.06617849,0.06593223,0.06573023,...
0.06557311,0.06546142,0.06539567,0.06537632,0.06540379,...
0.06547849,0.06560079,0.06577103,0.06598959,0.06625679,...
0.06657298,0.06693854,0.0673538,0.06781917,0.06833504,...
0.06890182,0.06951996,0.07018992,0.07091217,0.07168723,...
0.07251565,0.07339801,0.07433492,0.07532705,0.07637511,...
0.07747985,0.07864209,0.07986269,0.08114258,0.08248275,...
0.08388424,0.08534816,0.08687571,0.08846812,0.09016694,...
0.09200694,0.09401677,0.09621957,0.09863347,0.10127227,...
0.10414593,0.10726113,0.11062178,0.11422946,0.11808385,...
0.12218301,0.12652356,0.13110099,0.13590995,0.14094454,...
0.14619845,0.15166523,0.15733838,0.1632115,0.1692784,...
0.17553318,0.18197028,0.18858459,0.19537141,0.20232654,...
0.20944627,0.21672739,0.22416721,0.23176355,0.23951416,...
0.2474164,0.25546738,0.26366405,0.2720033,0.28048209,...
0.28909746,0.29784666,0.30672718,0.31573681,0.32487368,...
0.33413631,0.34352362,0.35303495,0.36267007,0.37242919,...
0.38231297,0.3923225,0.40245899,0.41272387,0.42311892,...
0.43364628,0.44430856,0.45510864,0.46604944,0.47713422,...
0.48836668,0.49975097,0.51129174,0.52299401,0.53486322,...
0.54690509,0.55912564,0.57153115,0.58412809,0.59692302,...
0.60992231,0.62313163,0.63655606,0.65020014,0.66406796,...
0.67816324,0.69248939,0.7070496,0.72184687,0.73688407,...
0.75216396,0.76768925,0.78346259,0.79948665,0.81576412,...
0.83229771,0.84909022,0.8661445,0.8834635,0.90105027,...
0.91890771,0.93703731,0.95543948,0.97411379,0.99305921,...
1.01227429,1.0317573,1.05150636,1.07151949,1.0917947,...
1.11233003,1.13312364,1.15417381,1.17547903,1.197038,...
1.21884969,1.24091333,1.26322847,1.28579498,1.30861306,...
1.33168327,1.35500647,1.37858627,1.40243266,1.42656086,...
1.45099023,1.47574329,1.50084491,1.5263216,1.55220102,...
1.57851144,1.60528149,1.63254008,1.66031626,1.68863913,...
1.71753776,1.74704106,1.7771777,1.80797607,1.83946416,...
1.87166953,1.9046193,1.93834004,1.97285782,2.00819811,...
2.04438588,2.08144558,2.11943323,2.15842351,2.1985005,...
2.23975088,2.28225929,2.32610497,2.37135963,2.41808615,...
2.4663379,2.51615846,2.56758173,2.62062833,2.67532438,...
2.73172534,2.78989996,2.84991074,2.91180249,2.97560107,...
3.04131414,3.10893201,3.17842886,3.24976391,3.32288281,...
3.39771904,3.47425478,3.55260616,3.63296656,3.71556294,...
3.80062257,3.88834899,3.97890233,4.07237958,4.16880392,...
4.26812357,4.37021352,4.47487889,4.58186,4.69083864,...
4.80144511,4.91326571,5.02584783,5.1386389,5.25102799,...
5.36237737,5.47204617,5.57940804,5.68386398,5.78485153,...
5.88184623,5.97436223,6.06195963,6.14424878,6.22089229,...
6.29160547,6.35615546,6.41435935,6.46608167,6.51123151,...
6.54975941,6.5816542,6.60693977,6.6256719,6.63793522,...
6.64384118,6.64352453,6.63714019,6.62486033,6.60687184,...
6.58337392,6.55457596,6.52069555,6.48195659,6.43858747,...
6.3908196,6.33888602,6.2830202,6.22345504,6.16042189,...
6.09414975,6.02486456,5.95278856,5.87813974,5.80113008,...
5.72195884,5.64081283,5.55786883,5.47329527,5.38725345,...
5.29989848,5.21137993,5.12184236,5.03142412,4.94025518,...
4.84845862,4.75615181,4.66344741,4.57045395,4.47727629,...
4.38402046,4.29079625,4.19771521,4.10488902,4.01242812,...
3.92044052,3.82903083,3.73829953,3.64834235,3.55924979,...
3.47110682,3.38399262,3.29798047,3.21313764,3.12952545,...
3.04719847,2.96620487,2.88658682,2.80838084,2.73161813,...
2.65632494,2.58252283,2.51022898,2.43945653,2.37021481,...
2.30250962,2.23634343,2.17171564,2.10862281,2.04705884,...
1.98701522,1.92848118,1.87144394,1.81588883,1.76179953,...
1.70915818,1.65794552,1.60814105,1.55972315,1.51266917,...
1.4669556,1.42255814,1.37945187,1.33761126,1.29701035,...
1.25762256,1.21942062,1.18237674,1.14646281,1.11165055,...
1.07791162,1.04521774,1.01354079,0.98285291,0.95312652,...
0.92433443,0.89644992,0.86944691,0.84330002,0.81798454,...
0.79347638,0.76975206,0.7467886,0.72456353,0.70305484,...
0.68224095,0.66210073,0.64261344,0.62375877,0.60551684,...
0.58786819,0.57079379,0.55427506,0.53829388,0.52283258,...
0.50787394,0.49340119,0.47939784,0.46584774,0.45273514,...
0.44004467,0.4277614,0.41587083,0.40435895,0.39321216,...
0.38241736];

fcapc = [0.0886879,0.08984792,0.07568581,0.06603215,0.05938144,...
0.05478498,0.05162497,0.04948681,0.0480856,0.04722181,...
0.04680769,0.04685468,0.04704479,0.04734755,0.04773967,...
0.04820343,0.04872542,0.04929559,0.04990648,0.05055262,...
0.05123015,0.05193638,0.05266959,0.05342875,0.05421344,...
0.05502364,0.05586522,0.05674592,0.05765649,0.05859336,...
0.0595559,0.06054499,0.06156217,0.0626093,0.06368533,...
0.06479409,0.06593862,0.06712119,0.06834368,0.06960775,...
0.07091497,0.07226686,0.07366493,0.0751107,0.07660571,...
0.07815152,0.07974974,0.08140199,0.08310994,0.0848753,...
0.08669982,0.08858528,0.09053352,0.09254641,0.0946259,...
0.09677397,0.09899264,0.10128401,0.10365023,0.1060935,...
0.10861609,0.11121655,0.11389203,0.1166467,0.11948465,...
0.12240983,0.12542609,0.12853719,0.13174686,0.1350588,...
0.13847671,0.14200434,0.14564545,0.14940391,0.15328365,...
0.15728869,0.16142314,0.16569125,0.17009738,0.174646,...
0.17934173,0.27946827,0.28978343,0.29964512,0.30913335,...
0.31835135,0.32739199,0.33634213,0.34528644,0.35429118,...
0.36340928,0.37268362,0.38191876,0.39091928,0.40010247,...
0.40948366,0.41907562,0.42889065,0.43893889,0.44922897,...
0.45976841,0.4705639,0.48162152,0.49294684,0.50454512,...
0.51642133,0.5285803,0.54102672,0.55376526,0.56680054,...
0.58017758,0.59246053,0.60404563,0.61578773,0.62770365,...
0.63981248,0.65213181,0.66467702,0.67746151,0.69051973,...
0.70386418,0.71750585,0.73145482,0.74572043,0.76031155,...
0.77523667,0.79050404,0.80612179,0.82209798,0.83772149,...
0.85381285,0.87044324,0.8875922,0.90523675,0.92302123,...
0.94055998,0.95906789,0.97828882,0.99808547,1.01838461,...
1.0391476,1.06035469,1.08199655,1.10412268,1.12672078,...
1.14970112,1.17299658,1.19609448,1.21837639,1.24093325,...
1.263787,1.28695418,1.31045205,1.33432426,1.35856359,...
1.38316106,1.40812179,1.43345469,1.45916957,1.48527602,...
1.51178301,1.53869886,1.56603135,1.59378781,1.62197528,...
1.65060061,1.67967059,1.70859466,1.73482814,1.76145146,...
1.78845356,1.81582594,1.8435623,1.87165828,1.90008782,...
1.92880614,1.95783146,1.98718021,2.01686729,2.04690628,...
2.07730973,2.10808939,2.13925641,2.1708215,2.20279507,...
2.23521775,2.2680816,2.30136172,2.33502842,2.37489984,...
2.42516363,2.47646372,2.52861401,2.58156113,2.63531182,...
2.6898976,2.74535814,2.80173384,2.85924324,2.91825328,...
2.97873524,3.04066815,3.10403785,3.16883607,3.2350596,...
3.3027096,3.37179097,3.44231186,3.5142833,3.5877188,...
3.66263418,3.73889297,3.81689879,3.89645011,4.05350581,...
4.19872081,4.33493915,4.46415642,4.58788528,4.70729545,...
4.82329839,4.93660394,5.04776115,5.15718956,5.26520397,...
5.36280476,5.50081238,5.7005865,5.88072706,6.0254749,...
6.14418454,6.25484982,6.36065797,6.46189901,6.55878838,...
6.6514785,6.74035265,6.82556885,7.04813354,7.49805675,...
7.88586711,8.2177403,8.49829148,8.73299241,8.91982482,...
9.04725474,9.12486118,9.16702464,9.17720359,9.15714457,...
9.10973866,9.03761213,8.94314943,8.82856364,8.6897886,...
8.37059159,8.07989308,7.81141354,7.56060951,7.32400471,...
7.09892653,6.88343242,6.66468178,6.44221639,6.23326952,...
6.03558692,5.84749079,5.66768799,5.4951603,5.32884596,...
5.16789403,5.01197048,4.86072167,4.71387991,4.57130827,...
4.43286438,4.2985143,4.17036109,4.04503486,3.92263434,...
3.80322527,3.68684803,3.57352304,3.46327682,3.35606683,...
3.25150481,3.14953895,3.05022106,2.95357508,2.85960662,...
2.76830832,2.67966305,2.59364587,2.51022543,2.42936496,...
2.35102311,2.27213318,2.1800304,2.0877359,2.0000931,...
1.91642059,1.83631388,1.75951194,1.68582864,1.61511733,...
1.54361358,1.46829141,1.39647374,1.32815713,1.26327947,...
1.20140286,1.14238025,1.0968016,1.06187579,1.02833232,...
0.99615355,0.96523606,0.93549872,0.90687552,0.87931087,...
0.85275843,0.82718561,0.80254001,0.77878228,0.75587662,...
0.7337898,0.71249058,0.68994998,0.66828647,0.64752923,...
0.62764005,0.6085771,0.59028263,0.5727174,0.55587464,...
0.53978425,0.5243141,0.50944096,0.4951409,0.48139006,...
0.46816509,0.45544335,0.44320307,0.43142336,0.42008424,...
0.40920165,0.39875952,0.38867251,0.3789274,0.3695109,...
0.36041006,0.35161249,0.34310635,0.3348804,0.32692396,...
0.31922684,0.31177755,0.30399782,0.29591249,0.28809927,...
0.28054922,0.27325362,0.26620392,0.2593917,0.25280868,...
0.24644674,0.24029817,0.23435657,0.22875636,0.22367654,...
0.21891523,0.21435062,0.20991103,0.20555611,0.20126506,...
0.1970291,0.19284656,0.18871984,0.18465343,0.1806526,...
0.17672268,0.17286858,0.16909452,0.16540373,0.16179858,...
0.15828083,0.15485163,0.15151149,0.14813751,0.14455089,...
0.14105006,0.13763696,0.13431435,0.13108351,0.12794268,...
0.12489012,0.12192393,0.11904206,0.11624236,0.11358616,...
0.11105515];

import casadi.*

A0=SX.sym('a0',[1,1]);
A1=SX.sym('a1',[1,1]);
A2=SX.sym('a2',[1,1]);
A3=SX.sym('a3',[1,1]);
B1=SX.sym('b1',[1,1]);
B2=SX.sym('b2',[1,1]);
B3=SX.sym('b3',[1,1]);
param_vec = [A0;A1;A2;A3;B1;B2;B3];
n = length(param_vec);

T = length(fcapc);
traj{1} = A0*fcapc(4)+A1*fcapc(3)+A2*fcapc(2)+A3*fcapc(1)+B1*fcfpc(3)+B2*fcfpc(2)+B3*fcfpc(1);
obj = (traj{1} - fcfpc(4))^2;
for t = 5:T
    traj{t-4} = A0*fcapc(t)+A1*fcapc(t-1)+A2*fcapc(t-2)+A3*fcapc(t-3)+B1*fcfpc(t-1)+B2*fcfpc(t-2)+B3*fcfpc(t-3);
    obj = obj + (traj{t-4} - fcfpc(t))^2;
end
traj_fun = Function('f',{param_vec},{vertcat(traj{:})});
obj_fun = Function('f',{param_vec},{obj});

nlp =   struct('x',param_vec,'f',obj_fun(param_vec));
cas =   nlpsol('solver','ipopt',nlp);
sol =   cas('lbx', -10*ones(n,1),...
            'ubx', 10*ones(n,1),...
            'x0', zeros(1,length(param_vec)));

% for i = 1:T-3
%    traj2(i)=(0.5*3/20)^3*ppgr(i)+(3/4)*ppapr(i)+(-1-3*0.5)*ppapr(i+1)+(2+3*(0.5)/2)*ppapr(i+2);
% end
        
hold on
plot(full(traj_fun(sol.x)))
plot(fcfpc(4:T))
% plot(traj2)
hold off